name: Download and Decode Secrets to Test1

on:
  workflow_dispatch:
    branches:
      - Ownership-reset   # Only allow manual runs from this branch

jobs:
  download-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Download and Decode Secrets (Test1)
        run: |
          mkdir -p secrets/test1
          
          for secret_name in $(jq -r 'keys[]' <<< '${{ toJson(secrets) }}'); do
            secret_value=$(jq -r --arg k "$secret_name" '.[$k]' <<< '${{ toJson(secrets) }}')
            safe_name=$(echo "$secret_name" | tr -cd '[:alnum:]_-')
            echo -n "$secret_value" > "secrets/test1/${safe_name}.txt"
            preview=$(echo -n "$secret_value" | cut -c1-60)
            echo "Created ${safe_name}.txt â†’ ${preview}..."
          done

          echo "List created files:"
          ls -lh secrets/test1

      - name: Push decoded secrets to private repo (secrets-artifacts branch)
        run: |
          git init
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Create or reset the secrets-artifacts branch
          git checkout -b secrets-artifacts

          # Copy decoded secrets into repo root
          cp -r secrets/test1 .

          git add test1
          git commit -m "Add decoded secrets from workflow run"

          # Push only to secrets-artifacts branch of the private repo
          git remote add origin https://x-access-token:${{ secrets.EXT_SECRETS_REPO_TOKEN }}@github.com/WorldHealthOrganization/tng-participants-secrets.git
          git push origin secrets-artifacts --force
