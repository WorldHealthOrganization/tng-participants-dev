name: Export and Encrypt Secrets

on:
  workflow_dispatch:

jobs:
  export-secrets:
    runs-on: ubuntu-latest

    steps:
    # - name: Checkout repository
    #   uses: actions/checkout@v4

    - name: Import GPG key
      run: |
        echo "${{ secrets.EXT_SECRETS_GPG_PUBLIC_KEY }}" | gpg --import
        gpg --list-keys

    - name: Export and Encrypt Secrets
      id: encrypt
      env:
        SECRETS: ${{ toJson(secrets) }}
        ENV: ${{ vars.EXT_SECRETS_ENV }}
      run: |
        mkdir -p secrets/${ENV}
        echo "$SECRETS" | jq -r 'keys[] as $k | "\($k):\(.[$k])"' | while IFS=: read -r name value; do
          if [[ ${#name} -eq 3 ]]; then
            echo -n "$value" | gpg --batch --yes --trust-model always --encrypt --armor -r "$(gpg --list-keys --with-colons | awk -F: '$1 == "uid" { print $10 }' | head -1)" > "secrets/dev/$name.b64"
          fi
        done
        echo "List created files"
        ls -la secrets/dev

    - name: Checkout participants-secrets repo
      uses: actions/checkout@v4
      env:
        REPO_TOKEN: ${{ secrets.EXT_SECRETS_REPO_TOKEN }}
      with:
        repository: WorldHealthOrganization/tng-participants-secrets
        ref: main
        path: participants-secrets

    - name: Copy secret files to participants-secrets folder
      env:
        ENV: ${{ vars.EXT_SECRETS_ENV }}
      run: |

        cd participants-secrets
        # Create or update the dev folder
        mkdir -p ${ENV}
        cp -r ../secrets/${ENV}/* ${ENV}/
        echo "The secrets in the ${ENV} folder are:"
        ls -la ${ENV}/ 

    # - name: Push secrets to participants-secrets repository
    #   env:
    #     REPO_TOKEN: ${{ secrets.SECRETS_REPO_TOKEN }}
    #     ENV: ${{ vars.ENV }}
    #   run: |
    #     git config --global user.name "github-actions[bot]"
    #     git config --global user.email "github-actions[bot]@users.noreply.github.com"

    #     cd participants-secrets

    #     # Create or update the dev folder
    #     mkdir -p dev
    #     cp -r ../secrets/dev/* dev/

    #     git add dev
    #     git commit -m "Add encrypted secrets from ${ENV}"
    #     git push "https://${REPO_TOKEN}@github.com/WorldHealthOrganization/tng-participants-secrets.git" main

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.EXT_SECRETS_REPO_TOKEN }}
        commit-message: Add encrypted secrets
        branch: secrets/dev
        title: Add encrypted secrets
        body: This PR adds the encrypted secrets to the dev folder.
        base: main